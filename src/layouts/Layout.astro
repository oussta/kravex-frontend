---
import '../styles/global.css';
import { getConfiguracion, getCategories } from '../lib/strapi.js';

const config = await getConfiguracion();
const categoriesData = await getCategories();

const { nombre_sitio, email_contacto, telefono, texto_footer } = config?.data?.attributes || {};
const categorias = categoriesData?.data || [];

const { title, description } = Astro.props;
---

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{title || 'KRAVEX | Ropa Old School & Fragancias Premium'}</title>
  <meta name="description" content={description || 'Descubre la colección premium de ropa old school y fragancias de lujo KRAVEX'} />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
</head>
<body>

  <!-- HEADER -->
  <header id="header" style="position:fixed;top:0;width:100%;z-index:100;background:rgba(10,10,10,0.85);backdrop-filter:blur(12px);border-bottom:1px solid rgba(255,255,255,0.05);transition:all 0.3s;">
    <div style="max-width:1280px;margin:0 auto;padding:0 32px;height:72px;display:flex;align-items:center;justify-content:space-between;">

      <div style="display:flex;align-items:center;gap:48px;">
        <a href="/" style="display:flex;align-items:center;gap:8px;text-decoration:none;">
          <span style="color:#D4AF37;font-size:20px;">★</span>
          <span style="color:#fff;font-size:20px;font-weight:800;letter-spacing:0.1em;">{nombre_sitio || 'KRAVEX'}</span>
        </a>
        <nav style="display:flex;gap:32px;" class="main-nav">
          <a href="/productos" style="color:#888;text-decoration:none;font-size:11px;font-weight:700;letter-spacing:0.2em;transition:color 0.2s;" onmouseover="this.style.color='#D4AF37'" onmouseout="this.style.color='#888'">COLECCIONES</a>
          <a href="/productos?categoria=fragancias" style="color:#888;text-decoration:none;font-size:11px;font-weight:700;letter-spacing:0.2em;transition:color 0.2s;" onmouseover="this.style.color='#D4AF37'" onmouseout="this.style.color='#888'">FRAGRANCE</a>
          <a href="/blog" style="color:#888;text-decoration:none;font-size:11px;font-weight:700;letter-spacing:0.2em;transition:color 0.2s;" onmouseover="this.style.color='#D4AF37'" onmouseout="this.style.color='#888'">EDITORIAL</a>
          <a href="/contacto" style="color:#888;text-decoration:none;font-size:11px;font-weight:700;letter-spacing:0.2em;transition:color 0.2s;" onmouseover="this.style.color='#D4AF37'" onmouseout="this.style.color='#888'">CONTACTO</a>
        </nav>
      </div>

      <div style="display:flex;align-items:center;gap:20px;">
        <button id="search-toggle" style="background:none;border:none;color:#888;cursor:pointer;padding:4px;transition:color 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#888'">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
          </svg>
        </button>
        <a href="/contacto" style="border:1px solid rgba(212,175,55,0.4);color:#D4AF37;padding:8px 20px;font-size:10px;font-weight:800;letter-spacing:0.2em;text-decoration:none;transition:all 0.2s;" onmouseover="this.style.background='#D4AF37';this.style.color='#000'" onmouseout="this.style.background='transparent';this.style.color='#D4AF37'">CUENTA</a>
        <button id="cart-toggle" style="background:none;border:none;color:#888;cursor:pointer;padding:4px;transition:color 0.2s;position:relative;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#888'">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/>
          </svg>
          <span id="cart-count" style="position:absolute;top:-6px;right:-6px;background:#D4AF37;color:#000;font-size:9px;font-weight:800;width:16px;height:16px;border-radius:50%;display:flex;align-items:center;justify-content:center;">0</span>
        </button>
      </div>
    </div>
  </header>

  <!-- SEARCH BAR -->
  <div id="search-bar" style="position:fixed;top:72px;left:0;right:0;z-index:99;background:#1A1A1A;border-bottom:1px solid rgba(212,175,55,0.2);padding:16px 32px;transform:translateY(-100%);opacity:0;transition:all 0.3s;pointer-events:none;">
    <div style="max-width:1280px;margin:0 auto;display:flex;align-items:center;gap:16px;">
      <input type="text" id="search-bar-input" placeholder="Buscar productos..." style="flex:1;background:transparent;border:none;border-bottom:1px solid rgba(212,175,55,0.3);color:#fff;font-size:16px;padding:8px 0;outline:none;font-family:inherit;" />
      <button id="search-close" style="background:none;border:none;color:#666;cursor:pointer;font-size:16px;">✕</button>
    </div>
  </div>

  <!-- CART OVERLAY -->
  <div id="cart-overlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:200;opacity:0;pointer-events:none;transition:opacity 0.3s;"></div>

  <!-- CART SIDEBAR -->
  <div id="cart-sidebar" style="position:fixed;top:0;right:-420px;width:420px;height:100vh;background:#1A1A1A;z-index:201;transition:right 0.3s ease;display:flex;flex-direction:column;border-left:1px solid rgba(212,175,55,0.1);">
    <div style="padding:24px;border-bottom:1px solid rgba(255,255,255,0.05);display:flex;justify-content:space-between;align-items:center;">
      <h3 style="font-size:12px;font-weight:800;letter-spacing:0.3em;color:#fff;">TU CARRITO</h3>
      <button id="cart-close" style="background:none;border:none;color:#666;cursor:pointer;font-size:18px;">✕</button>
    </div>
    <div id="cart-items" style="flex:1;overflow-y:auto;padding:24px;"></div>
    <div id="cart-footer" style="display:none;padding:24px;border-top:1px solid rgba(255,255,255,0.05);">
      <div style="display:flex;justify-content:space-between;margin-bottom:16px;font-size:13px;font-weight:700;letter-spacing:0.1em;">
        <span style="color:#fff;">TOTAL</span>
        <span id="cart-total" style="color:#D4AF37;">€0</span>
      </div>
      <button style="width:100%;background:#D4AF37;color:#000;border:none;padding:16px;font-size:11px;font-weight:800;letter-spacing:0.3em;cursor:pointer;font-family:inherit;transition:background 0.2s;" onmouseover="this.style.background='#B8941F'" onmouseout="this.style.background='#D4AF37'">
        FINALIZAR COMPRA
      </button>
    </div>
  </div>

  <!-- MAIN -->
  <main style="padding-top:72px;">
    <slot />
  </main>

  <!-- FOOTER -->
  <footer style="background:#0F0F0F;border-top:1px solid rgba(212,175,55,0.08);padding:80px 32px 32px;">
    <div style="max-width:1280px;margin:0 auto;display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:48px;margin-bottom:48px;" class="footer-grid">
      <div>
        <a href="/" style="display:flex;align-items:center;gap:8px;text-decoration:none;margin-bottom:16px;">
          <span style="color:#D4AF37;font-size:20px;">★</span>
          <span style="color:#fff;font-size:20px;font-weight:800;letter-spacing:0.1em;">{nombre_sitio || 'KRAVEX'}</span>
        </a>
        <p style="color:#555;font-size:13px;line-height:1.7;margin-bottom:24px;max-width:260px;">
          {texto_footer || 'Estableciendo el estándar global para el lujo moderno y la moda editorial. Establecido 2024.'}
        </p>
        <div style="display:flex;gap:16px;">
          <a href="#" style="color:#444;font-size:11px;font-weight:700;letter-spacing:0.1em;text-decoration:none;transition:color 0.2s;" onmouseover="this.style.color='#D4AF37'" onmouseout="this.style.color='#444'">IG</a>
          <a href="#" style="color:#444;font-size:11px;font-weight:700;letter-spacing:0.1em;text-decoration:none;transition:color 0.2s;" onmouseover="this.style.color='#D4AF37'" onmouseout="this.style.color='#444'">TW</a>
          <a href="#" style="color:#444;font-size:11px;font-weight:700;letter-spacing:0.1em;text-decoration:none;transition:color 0.2s;" onmouseover="this.style.color='#D4AF37'" onmouseout="this.style.color='#444'">FB</a>
        </div>
      </div>

      <div>
        <h4 style="color:#D4AF37;font-size:10px;font-weight:800;letter-spacing:0.3em;margin-bottom:20px;">TIENDA</h4>
        {categorias.map((cat) => (
          <a href={`/productos?categoria=${cat.attributes.slug}`} style="display:block;color:#555;font-size:13px;text-decoration:none;margin-bottom:10px;transition:color 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#555'">
            {cat.attributes.nombre}
          </a>
        ))}
        <a href="/productos" style="display:block;color:#555;font-size:13px;text-decoration:none;margin-bottom:10px;transition:color 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#555'">Todos los productos</a>
      </div>

      <div>
        <h4 style="color:#D4AF37;font-size:10px;font-weight:800;letter-spacing:0.3em;margin-bottom:20px;">EDITORIAL</h4>
        <a href="/blog" style="display:block;color:#555;font-size:13px;text-decoration:none;margin-bottom:10px;transition:color 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#555'">Journal</a>
        <a href="/blog" style="display:block;color:#555;font-size:13px;text-decoration:none;margin-bottom:10px;transition:color 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#555'">Últimos artículos</a>
        <a href="/blog" style="display:block;color:#555;font-size:13px;text-decoration:none;margin-bottom:10px;transition:color 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#555'">Guías de estilo</a>
      </div>

      <div>
        <h4 style="color:#D4AF37;font-size:10px;font-weight:800;letter-spacing:0.3em;margin-bottom:20px;">CONTACTO</h4>
        <a href={`mailto:${email_contacto || 'contacto@kravex.com'}`} style="display:block;color:#555;font-size:13px;text-decoration:none;margin-bottom:10px;transition:color 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#555'">{email_contacto || 'contacto@kravex.com'}</a>
        <a href={`tel:${telefono || '+34900000000'}`} style="display:block;color:#555;font-size:13px;text-decoration:none;margin-bottom:10px;transition:color 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#555'">{telefono || '+34 900 000 000'}</a>
        <a href="/contacto" style="display:block;color:#555;font-size:13px;text-decoration:none;margin-bottom:10px;transition:color 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#555'">Formulario de contacto</a>
      </div>
    </div>

    <div style="max-width:1280px;margin:0 auto;padding-top:32px;border-top:1px solid rgba(255,255,255,0.05);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px;">
      <span style="color:#333;font-size:11px;letter-spacing:0.05em;">{texto_footer || `© 2025 ${nombre_sitio || 'KRAVEX'}. Todos los derechos reservados.`}</span>
      <div style="display:flex;gap:24px;">
        <a href="#" style="color:#333;font-size:11px;text-decoration:none;letter-spacing:0.1em;transition:color 0.2s;" onmouseover="this.style.color='#D4AF37'" onmouseout="this.style.color='#333'">Privacidad</a>
        <a href="#" style="color:#333;font-size:11px;text-decoration:none;letter-spacing:0.1em;transition:color 0.2s;" onmouseover="this.style.color='#D4AF37'" onmouseout="this.style.color='#333'">Términos</a>
      </div>
    </div>
  </footer>

</body>
</html>

<style>
  @media (max-width: 1024px) {
    .footer-grid { grid-template-columns: 1fr 1fr !important; }
  }
  @media (max-width: 768px) {
    .main-nav { display: none !important; }
    .footer-grid { grid-template-columns: 1fr !important; gap: 32px !important; }
    #cart-sidebar { width: 100% !important; right: -100% !important; }
  }
</style>

<script>
  // ── CART SYSTEM WITH LOCALSTORAGE ────────────────────────
  let cart = [];

  // Load from localStorage on page load
  try {
    cart = JSON.parse(localStorage.getItem('kravex-cart') || '[]');
  } catch(e) {
    cart = [];
  }

  function saveCart() {
    try {
      localStorage.setItem('kravex-cart', JSON.stringify(cart));
    } catch(e) {}
  }

  function updateCartUI() {
    const count = cart.reduce((sum, item) => sum + item.qty, 0);
    const total = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);

    document.getElementById('cart-count').textContent = count;

    const cartItems = document.getElementById('cart-items');
    const cartFooter = document.getElementById('cart-footer');
    const cartTotal = document.getElementById('cart-total');

    if (cart.length === 0) {
      cartItems.innerHTML = `
        <div style="text-align:center;padding:60px 0;">
          <p style="color:#555;margin-bottom:16px;font-size:14px;">Tu carrito está vacío</p>
          <a href="/productos" style="color:#D4AF37;font-size:12px;letter-spacing:0.2em;text-decoration:none;">Ver productos</a>
        </div>`;
      cartFooter.style.display = 'none';
    } else {
      cartItems.innerHTML = cart.map(item => `
        <div style="display:flex;gap:16px;padding:16px 0;border-bottom:1px solid rgba(255,255,255,0.05);align-items:flex-start;">
          <div style="width:72px;height:72px;flex-shrink:0;background:#252525;overflow:hidden;">
            ${item.img
              ? `<img src="${item.img}" alt="${item.name}" style="width:100%;height:100%;object-fit:cover;" />`
              : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#333;font-size:20px;">★</div>`
            }
          </div>
          <div style="flex:1;min-width:0;">
            <div style="color:#fff;font-size:13px;font-weight:600;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${item.name}</div>
            <div style="color:#D4AF37;font-size:13px;font-weight:700;margin-bottom:8px;">€${item.price}</div>
            <div style="display:flex;align-items:center;gap:8px;">
              <button onclick="changeQty(${item.id}, -1)" style="background:#252525;border:none;color:#888;width:24px;height:24px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;line-height:1;">−</button>
              <span style="color:#fff;font-size:13px;min-width:16px;text-align:center;">${item.qty}</span>
              <button onclick="changeQty(${item.id}, 1)" style="background:#252525;border:none;color:#888;width:24px;height:24px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;line-height:1;">+</button>
            </div>
          </div>
          <button onclick="removeFromCart(${item.id})" style="background:none;border:none;color:#444;cursor:pointer;font-size:16px;padding:0;flex-shrink:0;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#444'">✕</button>
        </div>
      `).join('');
      cartFooter.style.display = 'block';
      cartTotal.textContent = `€${total}`;
    }
  }

  window.addToCart = function(id, name, price, img) {
    const existing = cart.find(i => i.id === id);
    if (existing) {
      existing.qty++;
    } else {
      cart.push({ id, name, price: Number(price), img: img || '', qty: 1 });
    }
    saveCart();
    updateCartUI();
    openCart();
  };

  window.changeQty = function(id, delta) {
    const item = cart.find(i => i.id === id);
    if (!item) return;
    item.qty += delta;
    if (item.qty <= 0) cart = cart.filter(i => i.id !== id);
    saveCart();
    updateCartUI();
  };

  window.removeFromCart = function(id) {
    cart = cart.filter(i => i.id !== id);
    saveCart();
    updateCartUI();
  };

  function openCart() {
    const isMobile = window.innerWidth <= 768;
    document.getElementById('cart-sidebar').style.right = '0';
    document.getElementById('cart-overlay').style.opacity = '1';
    document.getElementById('cart-overlay').style.pointerEvents = 'all';
    document.body.style.overflow = 'hidden';
  }

  function closeCart() {
    const isMobile = window.innerWidth <= 768;
    document.getElementById('cart-sidebar').style.right = isMobile ? '-100%' : '-420px';
    document.getElementById('cart-overlay').style.opacity = '0';
    document.getElementById('cart-overlay').style.pointerEvents = 'none';
    document.body.style.overflow = '';
  }

  document.getElementById('cart-toggle').addEventListener('click', openCart);
  document.getElementById('cart-close').addEventListener('click', closeCart);
  document.getElementById('cart-overlay').addEventListener('click', closeCart);

  // ── SEARCH ───────────────────────────────────────────────
  document.getElementById('search-toggle').addEventListener('click', () => {
    const bar = document.getElementById('search-bar');
    bar.style.transform = 'translateY(0)';
    bar.style.opacity = '1';
    bar.style.pointerEvents = 'all';
    document.getElementById('search-bar-input').focus();
  });

  document.getElementById('search-close').addEventListener('click', () => {
    const bar = document.getElementById('search-bar');
    bar.style.transform = 'translateY(-100%)';
    bar.style.opacity = '0';
    bar.style.pointerEvents = 'none';
  });

  // ── HEADER SCROLL ─────────────────────────────────────────
  window.addEventListener('scroll', () => {
    const header = document.getElementById('header');
    header.style.background = window.scrollY > 50
      ? 'rgba(10,10,10,0.98)'
      : 'rgba(10,10,10,0.85)';
  });

  // ── INIT ─────────────────────────────────────────────────
  updateCartUI();
</script>