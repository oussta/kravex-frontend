---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import { getProduct, getProducts } from '../../lib/strapi.js';

const { slug } = Astro.params;

const productData = await getProduct(slug);
const product = productData?.data?.[0];

if (!product) return Astro.redirect('/productos');

const { nombre, precio, descripcion, imagen, categoria, seo } = product.attributes;

const allProductsData = await getProducts();
const allProducts = allProductsData?.data || [];

const related = allProducts
  .filter(p => p.attributes.categoria?.data?.id === categoria?.data?.id && p.attributes.slug !== slug)
  .slice(0, 4);

const STRAPI_URL = import.meta.env.PUBLIC_STRAPI_URL || 'https://kravex-project.onrender.com';

const imgUrl = imagen?.data?.attributes?.url;
const imgMedium = imagen?.data?.attributes?.formats?.medium?.url || imgUrl;
const imgLarge = imagen?.data?.attributes?.formats?.large?.url || imgUrl;

const catNombre = categoria?.data?.attributes?.nombre || 'Premium';
const catSlug = categoria?.data?.attributes?.slug || '';

function getDescText(desc) {
  if (!desc || !Array.isArray(desc)) return '';
  return desc.map(b => b.children?.map(c => c.text).join('') || '').join('\n\n');
}
const descText = getDescText(descripcion);

const metaTitle = seo?.meta_title || `${nombre} | KRAVEX`;
const metaDesc = seo?.meta_description || descText.slice(0, 160);

const productJSON = JSON.stringify({
  id: product.id, nombre, precio,
  img: imgMedium ? `${STRAPI_URL}${imgMedium}` : '',
});
---

<Layout title={metaTitle} description={metaDesc}>

  <!-- BREADCRUMB -->
  <div style="padding:80px 32px 0; max-width:1280px; margin:0 auto;">
    <nav aria-label="Breadcrumb" style="margin-bottom:32px;">
      <ol style="list-style:none;padding:0;margin:0;display:flex;align-items:center;flex-wrap:wrap;gap:4px;">
        <li><a href="/" style="color:#444;font-size:11px;letter-spacing:0.1em;text-decoration:none;" onmouseover="this.style.color='#D4AF37'" onmouseout="this.style.color='#444'">INICIO</a></li>
        <li aria-hidden="true"><span style="color:#333;margin:0 4px;font-size:11px;">›</span></li>
        <li><a href="/productos" style="color:#444;font-size:11px;letter-spacing:0.1em;text-decoration:none;" onmouseover="this.style.color='#D4AF37'" onmouseout="this.style.color='#444'">COLECCIÓN</a></li>
        <li aria-hidden="true"><span style="color:#333;margin:0 4px;font-size:11px;">›</span></li>
        <li><a href={`/productos?categoria=${catSlug}`} style="color:#444;font-size:11px;letter-spacing:0.1em;text-decoration:none;" onmouseover="this.style.color='#D4AF37'" onmouseout="this.style.color='#444'">{catNombre.toUpperCase()}</a></li>
        <li aria-hidden="true"><span style="color:#333;margin:0 4px;font-size:11px;">›</span></li>
        <li><span aria-current="page" style="color:#fff;font-size:11px;letter-spacing:0.1em;">{nombre.toUpperCase()}</span></li>
      </ol>
    </nav>
  </div>

  <!-- PRODUCT DETAIL -->
  <article style="max-width:1280px; margin:0 auto; padding:0 32px 96px;">
    <div id="product-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:80px; align-items:start;">

      <!-- IMAGE -->
      <figure style="margin:0;">
        <div style="aspect-ratio:3/4; background:#1A1A1A; overflow:hidden; position:relative;">
          {imgLarge
            ? <img
                id="main-img"
                src={`${STRAPI_URL}${imgLarge}`}
                alt={`${nombre} - ${catNombre} KRAVEX`}
                style="width:100%; height:100%; object-fit:cover; transition:transform 0.6s ease;"
                onmouseover="this.style.transform='scale(1.04)'"
                onmouseout="this.style.transform='scale(1)'"
              />
            : <div aria-hidden="true" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#222;font-size:60px;">★</div>
          }
          <div aria-hidden="true" style="position:absolute;top:20px;left:20px;background:rgba(10,10,10,0.8);border:1px solid rgba(212,175,55,0.3);padding:6px 14px;">
            <span style="color:#D4AF37;font-size:9px;font-weight:700;letter-spacing:0.3em;">{catNombre.toUpperCase()}</span>
          </div>
        </div>

        {imgMedium &&
          <div style="display:flex;gap:12px;margin-top:16px;">
            <div style="width:80px;height:80px;background:#1A1A1A;overflow:hidden;border:1px solid #D4AF37;cursor:pointer;">
              <img src={`${STRAPI_URL}${imgMedium}`} alt={`Miniatura de ${nombre}`} style="width:100%;height:100%;object-fit:cover;" />
            </div>
          </div>
        }
      </figure>

      <!-- INFO -->
      <div style="position:sticky; top:96px;">
        <p style="color:#D4AF37;font-size:10px;font-weight:700;letter-spacing:0.4em;margin-bottom:16px;">{catNombre.toUpperCase()}</p>

        <h1 style="color:#fff;font-size:clamp(24px,3vw,38px);font-weight:700;letter-spacing:-0.02em;line-height:1.1;margin-bottom:16px;">{nombre}</h1>

        <p style="margin-bottom:32px;">
          <span style="color:#D4AF37;font-size:36px;font-weight:700;">€{precio}</span>
          <span style="color:#555;font-size:13px;margin-left:16px;">IVA incluido</span>
        </p>

        <!-- Description -->
        <div style="border-top:1px solid #1a1a1a;padding-top:24px;margin-bottom:32px;">
          {descText.split('\n\n').map(para => (
            <p style="color:#888;font-size:14px;line-height:1.85;margin-bottom:12px;">{para}</p>
          ))}
        </div>

        <!-- Add to cart -->
        <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:32px;">
          <button
            id="add-to-cart-btn"
            type="button"
            style="background:#D4AF37;color:#000;border:none;padding:18px 32px;font-size:11px;font-weight:800;letter-spacing:0.3em;cursor:pointer;font-family:inherit;transition:background 0.2s;width:100%;"
            onmouseover="this.style.background='#B8941F'"
            onmouseout="if(!this.dataset.added) this.style.background='#D4AF37'">
            AGREGAR AL CARRITO
          </button>
          <a href="/productos"
            style="border:1px solid #222;color:#555;padding:18px 32px;font-size:11px;font-weight:700;letter-spacing:0.2em;text-align:center;text-decoration:none;transition:all 0.2s;display:block;"
            onmouseover="this.style.borderColor='#333';this.style.color='#888'"
            onmouseout="this.style.borderColor='#222';this.style.color='#555'">
            SEGUIR COMPRANDO
          </a>
        </div>

        <!-- Details accordion -->
        <div style="border-top:1px solid #1a1a1a;padding-top:24px;">
          <details style="margin-bottom:12px;">
            <summary style="color:#888;font-size:11px;font-weight:700;letter-spacing:0.2em;cursor:pointer;padding:12px 0;list-style:none;display:flex;justify-content:space-between;align-items:center;">
              DETALLES DEL PRODUCTO
              <span aria-hidden="true" style="color:#D4AF37;">+</span>
            </summary>
            <div style="padding:16px 0;color:#555;font-size:13px;line-height:1.8;">
              <p>• Categoría: {catNombre}</p>
              <p>• Calidad premium garantizada</p>
              <p>• Envío en 2-5 días hábiles</p>
            </div>
          </details>
          <details style="margin-bottom:12px;">
            <summary style="color:#888;font-size:11px;font-weight:700;letter-spacing:0.2em;cursor:pointer;padding:12px 0;list-style:none;display:flex;justify-content:space-between;align-items:center;border-top:1px solid #1a1a1a;">
              ENVÍO Y DEVOLUCIONES
              <span aria-hidden="true" style="color:#D4AF37;">+</span>
            </summary>
            <div style="padding:16px 0;color:#555;font-size:13px;line-height:1.8;">
              <p>• Envío gratuito en pedidos +€150</p>
              <p>• Devoluciones en 30 días</p>
              <p>• Entrega express disponible</p>
            </div>
          </details>
        </div>
      </div>
    </div>
  </article>

  <!-- RELATED PRODUCTS -->
  {related.length > 0 &&
    <section aria-label="Productos relacionados" style="background:#111; border-top:1px solid rgba(212,175,55,0.07); padding:80px 32px;">
      <div style="max-width:1280px; margin:0 auto;">
        <header style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:40px;">
          <div>
            <p style="color:#D4AF37;font-size:10px;font-weight:700;letter-spacing:0.4em;margin-bottom:8px;">TAMBIÉN TE PUEDE GUSTAR</p>
            <h2 style="color:#fff;font-size:clamp(22px,3vw,32px);font-weight:700;letter-spacing:-0.02em;">Productos Relacionados</h2>
          </div>
          <a href={`/productos?categoria=${catSlug}`} style="color:#444;font-size:13px;text-decoration:none;" onmouseover="this.style.color='#D4AF37'" onmouseout="this.style.color='#444'">
            Ver todos →
          </a>
        </header>

        <ul id="related-grid" style="display:grid; grid-template-columns:repeat(4,1fr); gap:24px; list-style:none; padding:0; margin:0;">
          {related.map(p => {
            const { nombre: rNombre, precio: rPrecio, slug: rSlug, imagen: rImg } = p.attributes;
            const rImgUrl = rImg?.data?.attributes?.formats?.medium?.url || rImg?.data?.attributes?.url;
            return (
              <li>
                <article>
                  <a href={`/productos/${rSlug}`} style="text-decoration:none;" class="related-card">
                    <figure style="aspect-ratio:3/4;background:#1A1A1A;overflow:hidden;margin:0 0 14px;position:relative;">
                      {rImgUrl
                        ? <img src={`${STRAPI_URL}${rImgUrl}`} alt={`${rNombre} - KRAVEX`} loading="lazy" class="related-img" style="width:100%;height:100%;object-fit:cover;transition:transform 0.6s;" />
                        : <div aria-hidden="true" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#222;font-size:32px;">★</div>
                      }
                      <div class="related-overlay" aria-hidden="true" style="position:absolute;inset:0;background:rgba(0,0,0,0.4);opacity:0;transition:opacity 0.3s;display:flex;align-items:center;justify-content:center;">
                        <span style="color:#D4AF37;font-size:10px;font-weight:700;letter-spacing:0.3em;border:1px solid #D4AF37;padding:8px 16px;">VER</span>
                      </div>
                    </figure>
                    <h3 style="color:#fff;font-size:13px;font-weight:600;margin-bottom:4px;">{rNombre}</h3>
                    <p style="color:#D4AF37;font-size:13px;font-weight:700;margin:0;">€{rPrecio}</p>
                  </a>
                </article>
              </li>
            );
          })}
        </ul>
      </div>
    </section>
  }

</Layout>

<style>
  .related-card:hover .related-img { transform: scale(1.06) !important; }
  .related-card:hover .related-overlay { opacity: 1 !important; }
  details summary::-webkit-details-marker { display: none; }

  @media (max-width: 768px) {
    #product-grid { grid-template-columns: 1fr !important; gap: 32px !important; }
    #related-grid { grid-template-columns: repeat(2,1fr) !important; }
  }
</style>

<script define:vars={{ productJSON }}>
  const product = JSON.parse(productJSON);
  const btn = document.getElementById('add-to-cart-btn');

  btn.addEventListener('click', function() {
    if (typeof window.addToCart === 'function') {
      window.addToCart(product.id, product.nombre, product.precio, product.img);
    }
    this.dataset.added = 'true';
    this.textContent = '✓ AÑADIDO AL CARRITO';
    this.style.background = '#10B981';
    setTimeout(() => {
      this.textContent = 'AGREGAR AL CARRITO';
      this.style.background = '#D4AF37';
      delete this.dataset.added;
    }, 2000);
  });
</script>